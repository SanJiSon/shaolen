# Админка и круглосуточная работа бота

## Круглосуточный запуск (systemd)

Чтобы бот и веб-сервер не отключались при закрытии ноутбука и перезапускались при сбоях:

1. Скопируйте файлы из `systemd/` в systemd:
   ```bash
   sudo cp systemd/goals-bot.service /etc/systemd/system/
   sudo cp systemd/goals-webapp.service /etc/systemd/system/
   ```

2. Отредактируйте пути и пользователя в обоих файлах (обязательно **реальные** пути, не оставляйте `/path/to/...`):
   - `User=root` или ваш пользователь на сервере
   - `WorkingDirectory=/root/shaolen` — полный путь к папке проекта (где лежит `webapp_server.py` и `.env`)
   - `EnvironmentFile=/root/shaolen/.env` — тот же каталог + `/.env`
   - `ExecStart=` — полный путь к Python и к скрипту. Если используете venv: `/root/shaolen/venv/bin/python3 /root/shaolen/webapp_server.py` (для bot: `.../bot.py`). Без venv: `/usr/bin/python3 /root/shaolen/webapp_server.py`
   - Ошибки «Failed to load environment files: No such file or directory» и «Failed to run 'start' task» означают, что в юните всё ещё заглушки — проверьте, что все три пути (WorkingDirectory, EnvironmentFile, ExecStart) ведут в существующие файлы/каталоги.

3. Включите и запустите:
   ```bash
   sudo systemctl daemon-reload
   sudo systemctl enable goals-bot goals-webapp
   sudo systemctl start goals-bot goals-webapp
   ```

4. Проверка статуса и логов:
   ```bash
   sudo systemctl status goals-bot
   sudo systemctl status goals-webapp
   journalctl -u goals-bot -f
   journalctl -u goals-webapp -f
   ```

Логи также пишутся в папку `logs/`: `logs/bot.log` и `logs/webapp.log` — их можно смотреть в админ-странице в реальном времени.

## Админ-страница

Добавьте в `.env` переменную:
```
ADMIN_TOKEN=ваш_секретный_токен
```

Откройте в браузере (с того же домена, где развёрнут API):
```
https://ваш-домен.ru/admin.html?token=ваш_секретный_токен
```
или сохраните токен на странице в поле «ADMIN_TOKEN из .env» и нажмите «Сохранить и загрузить».

### Если везде «Ошибка: 403» (логи, процессы, пользователи)

403 значит: **токен не принят** — не совпадает с `ADMIN_TOKEN` в `.env` или не доходит до API.

**1. Проверить, что `ADMIN_TOKEN` задан и откуда его читает webapp**

На сервере, в каталоге проекта:

```bash
cd /path/to/telegram_goals_bot
grep ADMIN_TOKEN .env
```

Должна быть строка вида `ADMIN_TOKEN=ваш_секретный_токен` без лишних кавычек и пробелов вокруг `=`.  
Убедитесь, что сервис `goals-webapp` запущен с этим же `.env` (в юните указано `EnvironmentFile=/path/to/telegram_goals_bot/.env`).

**Символ `$` в токене:** при использовании `EnvironmentFile` в systemd символ `$` запускает подстановку переменных, из‑за этого токен может обрезаться или меняться. Чтобы передать буквальный `$`, продублируйте его: в `.env` пишите `$$` вместо одного `$`. Пример: токен `353kjk36jkdfg00_!%^$` задайте как `ADMIN_TOKEN=353kjk36jkdfg00_!%^$$`. После правок: `sudo systemctl restart goals-webapp`.

**2. Узнать, видит ли сервер ADMIN_TOKEN (без отправки своего токена)**

На сервере:

```bash
curl -s "http://127.0.0.1:8000/api/admin/check-env"
```

Ответ:
- `{"token_loaded":false,"token_length":0}` — переменная не задана или пустая: проверьте путь к `.env` в systemd и что в файле есть строка `ADMIN_TOKEN=...`.
- `{"token_loaded":true,"token_length":18}` — на сервере токен есть (длина 18). Длина вашего токена в ссылке/в поле ввода должна совпадать.

**3. Проверить API с токеном**

Подставьте свой токен и выполните на сервере:

```bash
curl -s "http://127.0.0.1:8000/api/admin/status?token=ВАШ_ТОКЕН_СЮДА"
```

- Ответ **200** и JSON с `bot`/`webapp` — токен верный.
- Ответ **403** — в теле есть поле `hint`: «ADMIN_TOKEN на сервере пустой» или «На сервере токен задан (длина N)». По нему видно, не читается ли .env или не совпадает ли длина/значение.

**4. Сравнить токен в ссылке и в `.env`**

- В ссылке должен быть **тот же** текст, что после `ADMIN_TOKEN=` в `.env`.
- Без лишних пробелов в начале/конце и без другой кодировки (если копируете из мессенджера, иногда подставляются невидимые символы). Лучше вручную набрать токен в `.env` и в ссылке из одного источника.

**5. Проверить через домен (как открывает браузер)**

С сервера (замените домен и токен):

```bash
curl -s -o /dev/null -w "%{http_code}" "https://shaolen.duckdns.org/api/admin/status?token=ВАШ_ТОКЕН"
```

Если тут **403**, а в п.3 по `127.0.0.1:8000` — **200**, значит Nginx или другой прокси режет или меняет query (например, не передаёт `?token=...`). Проверьте конфиг Nginx для `location /api/` и что в админке запросы уходят именно на `https://ваш-домен/api/admin/...?token=...`.

**6. В браузере (F12 → Network)**

Откройте админку по ссылке с `?token=...`, включите вкладку «Сеть», обновите страницу. Найдите запрос к `/api/admin/status` (или к логам):

- В **Request URL** должно быть `...?token=...` (или в заголовках — `X-Admin-Token`).
- Во вкладке **Response** при 403 будет `{"detail":"Неверный или отсутствующий ADMIN_TOKEN"}`.

Итого: чаще всего 403 даёт **разный токен в ссылке и в `.env`** или **пустой/не загруженный `ADMIN_TOKEN`** у процесса `webapp_server.py`. Проверка по п.1 и п.2 обычно сразу показывает причину.

На админ-странице доступно:
- **Процессы** — запущены ли bot.py и webapp_server.py (по systemd), кнопки «Запустить» / «Остановить»
- **Логи** — последние 500 строк из `bot.log` или `webapp.log`, автообновление каждые 3 сек
- **Пользователи** — таблица: id, имя, @username, число миссий/целей/привычек, число запросов к Шаолень; сводка: всего пользователей и сколько делали запросы к мастеру
- **Запросы к Шаолень** — таблица с датой, пользователем, кратким текстом запроса и пометкой «фото». По клику на строку раскрывается полный запрос и ответ; кнопка «Скопировать запрос в буфер»

Запуск/остановка через админку вызывает `systemctl start/stop goals-bot` и `goals-webapp`. Для этого процесс веб-сервера должен иметь права на выполнение systemctl (например, запуск от пользователя с passwordless sudo для этих команд, либо отдельный скрипт с setuid).

## История в боте (веб-приложение)

В чате с мастером Шаолень по кнопке «История» каждая строка стала раскрываемой: нажмите по строке — отобразится полный текст запроса и ответа. Кнопка «Скопировать запрос в буфер» копирует запрос и ответ в буфер обмена.
