import os
import logging
import asyncio
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ConversationHandler
from telegram.ext import ContextTypes
import aiosqlite
from datetime import datetime, timedelta
from typing import Dict, List, Optional

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è ConversationHandler
(MAIN_MENU, ADD_GOAL_NAME, ADD_GOAL_DESC, ADD_GOAL_DEADLINE, ADD_GOAL_PRIORITY,
 ADD_HABIT_NAME, ADD_HABIT_DESC, ADD_MISSION_NAME, ADD_MISSION_DESC) = range(9)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
async def init_db():
    async with aiosqlite.connect('goals_bot.db') as db:
        # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        await db.execute('''
            CREATE TABLE IF NOT EXISTS users (
                user_id INTEGER PRIMARY KEY,
                username TEXT,
                first_name TEXT,
                last_name TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ —Ü–µ–ª–µ–π
        await db.execute('''
            CREATE TABLE IF NOT EXISTS goals (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                name TEXT NOT NULL,
                description TEXT,
                deadline DATE,
                priority INTEGER DEFAULT 1,
                completed BOOLEAN DEFAULT 0,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users (user_id)
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–∏–≤—ã—á–µ–∫
        await db.execute('''
            CREATE TABLE IF NOT EXISTS habits (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                name TEXT NOT NULL,
                description TEXT,
                streak INTEGER DEFAULT 0,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users (user_id)
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏–≤—ã—á–µ–∫
        await db.execute('''
            CREATE TABLE IF NOT EXISTS habit_records (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                habit_id INTEGER,
                date DATE NOT NULL,
                completed BOOLEAN DEFAULT 0,
                FOREIGN KEY (habit_id) REFERENCES habits (id)
            )
        ''')
        
        await db.commit()

# –ö–æ–º–∞–Ω–¥–∞ /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id
    
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
    async with aiosqlite.connect('goals_bot.db') as db:
        await db.execute(
            "INSERT OR IGNORE INTO users (user_id, username, first_name, last_name) VALUES (?, ?, ?, ?)",
            (user_id, user.username, user.first_name, user.last_name)
        )
        await db.commit()
    
    # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    keyboard = [
        ["üéØ –¶–µ–ª–∏", "üîÑ –ü—Ä–∏–≤—ã—á–∫–∏"],
        ["üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "‚ÑπÔ∏è –ü–æ–º–æ—â—å"]
    ]
    
    await update.message.reply_text(
        f"–ü—Ä–∏–≤–µ—Ç, {user.first_name}! üëã\n"
        "–Ø —Ç–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–µ–π –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏–≤—ã—á–µ–∫.\n\n"
        "–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup={
            'keyboard': keyboard,
            'resize_keyboard': True,
            'one_time_keyboard': False
        }
    )
    
    return MAIN_MENU

# –ü–æ–∫–∞–∑–∞—Ç—å —Ü–µ–ª–∏
async def show_goals(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    
    async with aiosqlite.connect('goals_bot.db') as db:
        cursor = await db.execute(
            "SELECT id, name, description, deadline, priority, completed FROM goals WHERE user_id = ? ORDER BY priority, deadline",
            (user_id,)
        )
        goals = await cursor.fetchall()
    
    if not goals:
        await update.message.reply_text("–£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç —Ü–µ–ª–µ–π. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é!")
        return MAIN_MENU
    
    response = "üìã –¢–≤–æ–∏ —Ü–µ–ª–∏:\n\n"
    for goal in goals:
        id, name, desc, deadline, priority, completed = goal
        status = "‚úÖ" if completed else "‚è≥"
        response += f"{status} *{name}*\n"
        if desc:
            response += f"   üìù {desc}\n"
        if deadline:
            response += f"   üìÖ –î–æ: {deadline}\n"
        response += f"   üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {'üî¥' if priority == 1 else 'üü°' if priority == 2 else 'üü¢'}\n\n"
    
    await update.message.reply_text(response, parse_mode='Markdown')
    return MAIN_MENU

# –ù–∞—á–∞—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–ª–∏
async def add_goal_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("–ö–∞–∫ –Ω–∞–∑–æ–≤–µ–º —Ü–µ–ª—å?")
    return ADD_GOAL_NAME

# –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏
async def add_goal_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['goal_name'] = update.message.text
    await update.message.reply_text("–û–ø–∏—à–∏ —Ü–µ–ª—å (–∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å '-' —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å):")
    return ADD_GOAL_DESC

# –ü–æ–ª—É—á–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ü–µ–ª–∏
async def add_goal_desc(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.text != '-':
        context.user_data['goal_desc'] = update.message.text
    await update.message.reply_text("–£–∫–∞–∂–∏ –¥–µ–¥–ª–∞–π–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î (–∏–ª–∏ '-'):")
    return ADD_GOAL_DEADLINE

# –ü–æ–ª—É—á–∏—Ç—å –¥–µ–¥–ª–∞–π–Ω —Ü–µ–ª–∏
async def add_goal_deadline(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.text != '-':
        context.user_data['goal_deadline'] = update.message.text
    await update.message.reply_text("–£–∫–∞–∂–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (1-3, –≥–¥–µ 1 - —Å–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π):")
    return ADD_GOAL_PRIORITY

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–ª—å
async def add_goal_save(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    
    try:
        priority = int(update.message.text)
        if priority < 1 or priority > 3:
            priority = 2
    except:
        priority = 2
    
    async with aiosqlite.connect('goals_bot.db') as db:
        await db.execute(
            '''INSERT INTO goals (user_id, name, description, deadline, priority) 
               VALUES (?, ?, ?, ?, ?)''',
            (user_id, 
             context.user_data.get('goal_name'),
             context.user_data.get('goal_desc'),
             context.user_data.get('goal_deadline'),
             priority)
        )
        await db.commit()
    
    # –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    context.user_data.clear()
    
    await update.message.reply_text("üéâ –¶–µ–ª—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!")
    return await show_goals(update, context)

# –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–≤—ã—á–∫–∏
async def show_habits(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    
    async with aiosqlite.connect('goals_bot.db') as db:
        cursor = await db.execute(
            "SELECT id, name, description, streak FROM habits WHERE user_id = ? ORDER BY created_at",
            (user_id,)
        )
        habits = await cursor.fetchall()
    
    if not habits:
        await update.message.reply_text("–£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∏–≤—ã—á–µ–∫. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é!")
        return MAIN_MENU
    
    response = "üîÑ –¢–≤–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏:\n\n"
    for habit in habits:
        id, name, desc, streak = habit
        response += f"üî• *{name}*\n"
        if desc:
            response += f"   üìù {desc}\n"
        response += f"   üìà –°–µ—Ä–∏—è: {streak} –¥–Ω–µ–π\n\n"
    
    await update.message.reply_text(response, parse_mode='Markdown')
    return MAIN_MENU

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
async def show_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    
    async with aiosqlite.connect('goals_bot.db') as db:
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ü–µ–ª—è–º
        cursor = await db.execute(
            "SELECT COUNT(*), SUM(completed) FROM goals WHERE user_id = ?",
            (user_id,)
        )
        goals_total, goals_completed = await cursor.fetchone()
        goals_completed = goals_completed or 0
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–∏–≤—ã—á–∫–∞–º
        cursor = await db.execute(
            "SELECT COUNT(*), SUM(streak) FROM habits WHERE user_id = ?",
            (user_id,)
        )
        habits_total, total_streak = await cursor.fetchone()
        habits_total = habits_total or 0
        total_streak = total_streak or 0
        
        # –ê–∫—Ç–∏–≤–Ω—ã–µ —Ü–µ–ª–∏
        cursor = await db.execute(
            "SELECT name FROM goals WHERE user_id = ? AND completed = 0 ORDER BY priority LIMIT 3",
            (user_id,)
        )
        active_goals = await cursor.fetchall()
    
    response = (
        f"üìä *–¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞*\n\n"
        f"üéØ –¶–µ–ª–∏: {goals_completed}/{goals_total} –∑–∞–≤–µ—Ä—à–µ–Ω—ã\n"
        f"üîÑ –ü—Ä–∏–≤—ã—á–µ–∫: {habits_total}\n"
        f"üî• –û–±—â–∞—è —Å–µ—Ä–∏—è: {total_streak} –¥–Ω–µ–π\n\n"
    )
    
    if active_goals:
        response += "*–ê–∫—Ç–∏–≤–Ω—ã–µ —Ü–µ–ª–∏:*\n"
        for goal in active_goals:
            response += f"‚Ä¢ {goal[0]}\n"
    
    await update.message.reply_text(response, parse_mode='Markdown')
    return MAIN_MENU

# –ü–æ–º–æ—â—å
async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    help_text = (
        "üìñ *–ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É*\n\n"
        "*–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*\n"
        "/start - –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞\n"
        "/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n"
        "/cancel - –û—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è\n\n"
        "*–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–ª—è–º–∏:*\n"
        "1. –ù–∞–∂–º–∏ 'üéØ –¶–µ–ª–∏'\n"
        "2. –ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è\n\n"
        "*–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–µ–∫:*\n"
        "1. –ù–∞–∂–º–∏ 'üîÑ –ü—Ä–∏–≤—ã—á–∫–∏'\n"
        "2. –î–æ–±–∞–≤–ª—è–π –∏ –æ—Ç–º–µ—á–∞–π –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ\n\n"
        "*–°–æ–≤–µ—Ç—ã:*\n"
        "‚Ä¢ –°—Ç–∞–≤—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–µ–ª–∏\n"
        "‚Ä¢ –ù–∞—á–∏–Ω–∞–π —Å –º–∞–ª–µ–Ω—å–∫–∏—Ö –ø—Ä–∏–≤—ã—á–µ–∫\n"
        "‚Ä¢ –û—Ç–º–µ—á–∞–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–π –¥–µ–Ω—å"
    )
    
    await update.message.reply_text(help_text, parse_mode='Markdown')
    return MAIN_MENU

# –û—Ç–º–µ–Ω–∞
async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    await update.message.reply_text("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    return await start(update, context)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    
    if text == "üéØ –¶–µ–ª–∏":
        keyboard = [
            ["üìã –ú–æ–∏ —Ü–µ–ª–∏", "‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å"],
            ["üîô –ù–∞–∑–∞–¥"]
        ]
        await update.message.reply_text(
            "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–ª—è–º–∏:",
            reply_markup={
                'keyboard': keyboard,
                'resize_keyboard': True
            }
        )
        return MAIN_MENU
    
    elif text == "üîÑ –ü—Ä–∏–≤—ã—á–∫–∏":
        return await show_habits(update, context)
    
    elif text == "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞":
        return await show_stats(update, context)
    
    elif text == "‚ÑπÔ∏è –ü–æ–º–æ—â—å":
        return await help_command(update, context)
    
    elif text == "üìã –ú–æ–∏ —Ü–µ–ª–∏":
        return await show_goals(update, context)
    
    elif text == "‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å":
        return await add_goal_start(update, context)
    
    elif text == "üîô –ù–∞–∑–∞–¥":
        return await start(update, context)
    
    else:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.")
        return MAIN_MENU

# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
def main():
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    TOKEN = os.getenv('BOT_TOKEN')
    if not TOKEN:
        logger.error("–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω! –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env —Å BOT_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω")
        return
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    application = Application.builder().token(TOKEN).build()
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ë–î
    asyncio.run(init_db())
    
    # Conversation Handler –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ü–µ–ª–∏
    conv_handler = ConversationHandler(
        entry_points=[
            CommandHandler('start', start),
            MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message)
        ],
        states={
            MAIN_MENU: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message)
            ],
            ADD_GOAL_NAME: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, add_goal_name)
            ],
            ADD_GOAL_DESC: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, add_goal_desc)
            ],
            ADD_GOAL_DEADLINE: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, add_goal_deadline)
            ],
            ADD_GOAL_PRIORITY: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, add_goal_save)
            ],
        },
        fallbacks=[CommandHandler('cancel', cancel)]
    )
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    application.add_handler(conv_handler)
    application.add_handler(CommandHandler('help', help_command))
    application.add_handler(CommandHandler('cancel', cancel))
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    application.run_polling()

if __name__ == '__main__':
    main()
