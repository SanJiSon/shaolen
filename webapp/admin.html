<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ê–¥–º–∏–Ω ‚Äî Goals Bot</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; margin: 0; padding: 16px; background: #0f172a; color: #e2e8f0; }
    h1 { margin: 0 0 16px; font-size: 20px; }
    .token-row { margin-bottom: 16px; }
    .token-row input { width: 300px; padding: 8px; margin-right: 8px; background: #1e293b; border: 1px solid #334155; color: #e2e8f0; border-radius: 6px; }
    .token-row button { padding: 8px 14px; background: #7c3aed; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    .admin-tabs { display: flex; gap: 4px; margin-bottom: 16px; border-bottom: 1px solid #334155; }
    .admin-tabs button { padding: 10px 16px; background: transparent; color: #94a3b8; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-size: 14px; margin-bottom: -1px; }
    .admin-tabs button:hover { color: #e2e8f0; }
    .admin-tabs button.active { color: #7c3aed; border-bottom-color: #7c3aed; }
    .admin-tab-panel { display: none; }
    .admin-tab-panel.active { display: block; }
    section { margin-bottom: 24px; }
    section h2 { font-size: 16px; margin: 0 0 10px; color: #94a3b8; }
    .status-box { display: flex; gap: 16px; flex-wrap: wrap; align-items: center; }
    .proc { padding: 10px 16px; background: #1e293b; border-radius: 8px; display: flex; align-items: center; gap: 10px; }
    .proc .dot { width: 10px; height: 10px; border-radius: 50%; }
    .proc .dot.active { background: #22c55e; }
    .proc .dot.inactive { background: #f43f5e; }
    .proc .dot.unknown { background: #94a3b8; }
    .proc button { padding: 6px 12px; font-size: 12px; background: #334155; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    .proc button:hover { background: #475569; }
    .proc button:disabled { opacity: 0.5; cursor: not-allowed; }
    .token-row.token-ok { margin-bottom: 8px; }
    .token-row.token-ok .token-compact { color: #22c55e; }
    .logs-toolbar { margin-bottom: 8px; display: flex; gap: 8px; align-items: center; }
    .logs-toolbar select { padding: 6px 10px; background: #1e293b; color: #e2e8f0; border: 1px solid #334155; border-radius: 4px; }
    .logs-box { background: #0c0e14; border: 1px solid #334155; border-radius: 8px; padding: 12px; max-height: 400px; overflow: auto; font-family: monospace; font-size: 12px; white-space: pre-wrap; word-break: break-all; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; background: #1e293b; border-radius: 8px; overflow: hidden; }
    th, td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #334155; }
    th { background: #0f172a; color: #94a3b8; font-weight: 600; }
    .summary { display: flex; gap: 16px; margin-bottom: 12px; flex-wrap: wrap; }
    .summary span { padding: 8px 14px; background: #1e293b; border-radius: 6px; }
    .req-row { cursor: pointer; }
    .req-row.expanded { background: #0f172a; }
    .req-full { padding: 10px; background: #0c0e14; border-radius: 6px; margin-top: 6px; font-size: 12px; white-space: pre-wrap; max-height: 200px; overflow: auto; }
    .copy-btn { padding: 4px 8px; font-size: 11px; background: #7c3aed; color: #fff; border: none; border-radius: 4px; cursor: pointer; margin-top: 4px; }
    .copy-btn:hover { background: #8b5cf6; }
    .err { color: #f43f5e; }
    .btn-sm { padding: 4px 10px; font-size: 12px; background: #475569; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    .btn-sm:hover { background: #64748b; }
    .user-data-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
    .user-data-modal .modal-inner { background: #1e293b; border-radius: 12px; max-width: 600px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; border: 1px solid #334155; }
    .user-data-modal .modal-header { padding: 14px 16px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
    .user-data-modal .modal-body { padding: 16px; overflow-y: auto; font-size: 13px; }
    .user-data-modal .modal-body h3 { margin: 12px 0 6px; font-size: 14px; color: #94a3b8; }
    .user-data-modal .user-data-profile { margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #334155; }
    .user-data-modal .user-data-profile h3 { margin-top: 0; }
    .user-data-modal .user-data-profile p { margin: 6px 0; font-size: 13px; }
    .user-data-modal .modal-body ul { margin: 0; padding-left: 20px; }
    .user-data-modal .modal-body li { margin: 4px 0; }
    .user-data-modal .modal-close { background: #334155; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
    .user-data-modal .modal-close:hover { background: #475569; }
    .control-hint { font-size: 12px; color: #94a3b8; margin-top: 8px; }
  </style>
</head>
<body>
  <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Goals Bot</h1>
  <div class="token-row" id="token-row">
    <span class="token-compact" id="token-compact" style="display:none;"></span>
    <span class="token-enter" id="token-enter">
      <input type="password" id="token-inp" placeholder="ADMIN_TOKEN –∏–∑ .env –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É —Å ?token=..." />
      <button type="button" id="token-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </span>
    <span id="token-msg"></span>
  </div>

  <div class="admin-tabs" id="admin-tabs">
    <button type="button" class="admin-tab-btn active" data-tab="logs">–õ–æ–≥–∏ –∏ –ø—Ä–æ—Ü–µ—Å—Å—ã</button>
    <button type="button" class="admin-tab-btn" data-tab="users" id="tab-btn-users" style="display:none;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
    <button type="button" class="admin-tab-btn" data-tab="requests" id="tab-btn-requests" style="display:none;">–ó–∞–ø—Ä–æ—Å—ã</button>
  </div>

  <div id="panel-logs" class="admin-tab-panel active">
    <section id="sec-status">
      <h2>–ü—Ä–æ—Ü–µ—Å—Å—ã</h2>
      <div class="status-box">
        <div class="proc" id="proc-bot"><span class="dot unknown" id="dot-bot"></span><span>bot.py</span><span id="status-bot">‚Äî</span><button id="btn-bot-start">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button><button id="btn-bot-stop">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button></div>
        <div class="proc" id="proc-webapp"><span class="dot unknown" id="dot-webapp"></span><span>webapp_server.py</span><span id="status-webapp">‚Äî</span><button id="btn-webapp-start">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button><button id="btn-webapp-stop">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button></div>
      </div>
      <p class="control-hint">–ï—Å–ª–∏ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –∫–Ω–æ–ø–∫–∞ ¬´–ó–∞–ø—É—Å—Ç–∏—Ç—å¬ª –¥–ª—è webapp –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å 502 ‚Äî –∑–∞–ø—Ä–æ—Å –∏–¥—ë—Ç —á–µ—Ä–µ–∑ –Ω–µ–≥–æ. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: <code>systemctl start goals-webapp</code></p>
    </section>
    <section id="sec-logs">
      <h2>–õ–æ–≥–∏ (—Ä–µ–∂–∏–º —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏)</h2>
      <div class="logs-toolbar">
        <select id="logs-source"><option value="bot">bot.log</option><option value="webapp">webapp.log</option></select>
        <button type="button" id="logs-refresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <label><input type="checkbox" id="logs-auto" /> –æ–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫</label>
      </div>
      <div class="logs-box" id="logs-box"></div>
    </section>
  </div>

  <div id="panel-users" class="admin-tab-panel">
    <section id="sec-users">
      <h2>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
      <div class="summary" id="users-summary"></div>
      <div style="overflow-x: auto;"><table id="users-table"><thead><tr><th>user_id</th><th>–ò–º—è</th><th>@username</th><th>–ú–∏—Å—Å–∏–∏</th><th>–¶–µ–ª–∏</th><th>–ü—Ä–∏–≤—ã—á–∫–∏</th><th>–ó–∞–ø—Ä–æ—Å–æ–≤ –®–∞–æ–ª–µ–Ω—å</th><th></th></tr></thead><tbody></tbody></table></div>
    </section>
  </div>

  <div id="panel-requests" class="admin-tab-panel">
    <section id="sec-requests">
      <h2>–ó–∞–ø—Ä–æ—Å—ã –∫ –º–∞—Å—Ç–µ—Ä—É –®–∞–æ–ª–µ–Ω—å</h2>
      <div style="overflow-x: auto;"><table id="requests-table"><thead><tr><th>–î–∞—Ç–∞</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–ó–∞–ø—Ä–æ—Å</th><th>–§–æ—Ç–æ</th></tr></thead><tbody></tbody></table></div>
    </section>
  </div>

  <div id="user-data-modal" class="user-data-modal" style="display:none;">
    <div class="modal-inner">
      <div class="modal-header"><span id="user-data-title">–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span><button type="button" class="modal-close" id="user-data-close">–ó–∞–∫—Ä—ã—Ç—å</button></div>
      <div class="modal-body" id="user-data-body"></div>
    </div>
  </div>

  <script>
(function() {
  var BASE = window.location.origin;
  var rawQuery = window.location.search || '';
  var urlToken = (new URLSearchParams(rawQuery).get('token') || '').trim();
  var showExtendedTabs = (window.location.href.indexOf('@@@@@') !== -1) || (urlToken.indexOf('@@@@@') !== -1);
  if (urlToken.indexOf('@@@@@') !== -1) urlToken = urlToken.replace(/@@@@@.*$/, '').trim();
  var token = urlToken || (localStorage.getItem('admin_token') || '').trim();
  if (token.indexOf('@@@@@') !== -1) token = token.replace(/@@@@@.*$/, '').trim();
  if (urlToken) localStorage.setItem('admin_token', token);

  function headers() {
    var h = { 'Content-Type': 'application/json' };
    if (token) h['X-Admin-Token'] = token;
    return h;
  }
  function q(s) { return document.querySelector(s); }
  function qs(s) { return document.querySelectorAll(s); }

  function api(path, opts) {
    opts = opts || {};
    var url = BASE + path + (token && path.indexOf('?') === -1 ? '?token=' + encodeURIComponent(token) : '');
    return fetch(url, { headers: headers(), method: opts.method || 'GET', body: opts.body }).then(function(r) {
      var err = new Error(r.status + ' ' + r.statusText);
      err.status = r.status;
      if (!r.ok) return r.text().then(function(t) { err.body = t; throw err; });
      return r.json();
    });
  }

  function showMsg(el, text, isErr) {
    if (!el) return;
    el.textContent = text;
    el.className = isErr ? 'err' : '';
  }

  function updateTokenUI() {
    var row = q('#token-row');
    var compact = q('#token-compact');
    var enter = q('#token-enter');
    if (token) {
      row.classList.add('token-ok');
      compact.style.display = '';
      compact.innerHTML = '–¢–æ–∫–µ–Ω –∏–∑ —Å—Å—ã–ª–∫–∏ ‚úì' + (urlToken ? '' : ' (—Å–æ—Ö—Ä–∞–Ω—ë–Ω)') + ' <button type="button" id="token-change" style="margin-left:8px;padding:4px 8px;font-size:12px;background:#334155;color:#fff;border:none;border-radius:4px;cursor:pointer;">–ò–∑–º–µ–Ω–∏—Ç—å</button>';
      enter.style.display = 'none';
      q('#token-change').onclick = function() { token = ''; localStorage.removeItem('admin_token'); compact.style.display = 'none'; enter.style.display = ''; row.classList.remove('token-ok'); showMsg(q('#token-msg'), ''); };
    } else {
      row.classList.remove('token-ok');
      compact.style.display = 'none';
      enter.style.display = '';
    }
  }

  if (showExtendedTabs) {
    q('#tab-btn-users').style.display = '';
    q('#tab-btn-requests').style.display = '';
  }
  qs('.admin-tab-btn').forEach(function(btn) {
    if (btn.style.display === 'none') return;
    btn.onclick = function() {
      qs('.admin-tab-btn').forEach(function(b) { b.classList.remove('active'); });
      qs('.admin-tab-panel').forEach(function(p) { p.classList.remove('active'); });
      btn.classList.add('active');
      var tab = btn.dataset.tab;
      var panel = q('#panel-' + tab);
      if (panel) panel.classList.add('active');
      if (tab === 'users') loadUsers();
      if (tab === 'requests') loadRequests();
    };
  });

  var tokenInp = q('#token-inp');
  var tokenMsg = q('#token-msg');
  if (token) tokenInp.value = token;
  updateTokenUI();
  q('#token-save').onclick = function() {
    var v = (tokenInp.value || '').trim();
    var fromUrl = v.indexOf('token=') !== -1 ? (new URLSearchParams((v.split('?')[1] || '')).get('token') || '').trim() : '';
    var raw = fromUrl || v;
    if (raw.indexOf('@@@@@') !== -1) { showExtendedTabs = true; raw = raw.replace(/@@@@@.*$/, '').trim(); q('#tab-btn-users').style.display = ''; q('#tab-btn-requests').style.display = ''; }
    token = raw;
    if (!token) { showMsg(tokenMsg, '–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –∏–ª–∏ —Å—Å—ã–ª–∫—É —Å ?token=...', true); return; }
    localStorage.setItem('admin_token', token);
    showMsg(tokenMsg, '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    updateTokenUI();
    loadStatus(); loadLogs(); if (showExtendedTabs) { loadUsers(); loadRequests(); }
  };

  function loadStatus() {
    if (!token) return;
    api('/api/admin/status').then(function(d) {
      var b = d.bot || 'unknown', w = d.webapp || 'unknown';
      q('#status-bot').textContent = b === 'active' ? '–∑–∞–ø—É—â–µ–Ω' : (b === 'inactive' ? '–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '?');
      q('#status-webapp').textContent = w === 'active' ? '–∑–∞–ø—É—â–µ–Ω' : (w === 'inactive' ? '–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '?');
      q('#dot-bot').className = 'dot ' + b;
      q('#dot-webapp').className = 'dot ' + w;
      q('#btn-bot-start').disabled = b === 'active';
      q('#btn-bot-stop').disabled = b === 'inactive';
      q('#btn-webapp-start').disabled = w === 'active';
      q('#btn-webapp-stop').disabled = w === 'inactive';
    }).catch(function(e) { q('#status-bot').textContent = '–æ—à–∏–±–∫–∞'; q('#status-webapp').textContent = '–æ—à–∏–±–∫–∞'; q('#dot-bot').className = 'dot unknown'; q('#dot-webapp').className = 'dot unknown'; });
  }
  function postControl(what, action) {
    if (!token) return;
    var path = '/api/admin/' + (what === 'bot' ? 'bot' : 'webapp') + '/' + action;
    fetch(BASE + path + '?token=' + encodeURIComponent(token), { headers: headers(), method: 'POST' })
      .then(function(r) {
        if (r.ok) { loadStatus(); return; }
        return r.text().then(function(t) {
          var msg = r.status + ' ' + r.statusText;
          if (r.status === 502 || r.status === 503 || (r.status >= 500 && r.status < 600)) {
            if (what === 'webapp' && action === 'start') msg += '. –ï—Å–ª–∏ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –∑–∞–ø—Ä–æ—Å –∏–¥—ë—Ç —á–µ—Ä–µ–∑ –Ω–µ–≥–æ ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: systemctl start goals-webapp';
            else if (what === 'bot' && action === 'start') msg += '. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: systemctl start goals-bot';
          }
          alert(msg);
        });
      })
      .catch(function(e) {
        var msg = e.message || '–û—à–∏–±–∫–∞';
        if (e.status === 502 || e.status === 500) msg += '. –í–æ–∑–º–æ–∂–Ω–æ, —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: systemctl start goals-' + (what === 'bot' ? 'bot' : 'webapp');
        alert(msg);
      });
  }
  q('#btn-bot-start').onclick = function() { postControl('bot', 'start'); };
  q('#btn-bot-stop').onclick = function() { postControl('bot', 'stop'); };
  q('#btn-webapp-start').onclick = function() { postControl('webapp', 'start'); };
  q('#btn-webapp-stop').onclick = function() { postControl('webapp', 'stop'); };

  function loadLogs() {
    if (!token) return;
    var src = q('#logs-source').value;
    api('/api/admin/logs?source=' + src + '&n=500').then(function(d) {
      q('#logs-box').textContent = (d.lines || []).join('');
      q('#logs-box').scrollTop = q('#logs-box').scrollHeight;
    }).catch(function(e) { q('#logs-box').textContent = '–û—à–∏–±–∫–∞: ' + (e.message || e); });
  }
  q('#logs-refresh').onclick = loadLogs;
  q('#logs-source').onchange = loadLogs;
  setInterval(function() { if (q('#logs-auto') && q('#logs-auto').checked && token) loadLogs(); }, 3000);

  function escapeHtml(s) {
    if (s == null) return '';
    var d = document.createElement('div'); d.textContent = String(s); return d.innerHTML;
  }

  function loadUsers() {
    if (!token) return;
    api('/api/admin/users').then(function(d) {
      var users = d.users || [];
      q('#users-summary').innerHTML = '<span>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + (d.total_users || 0) + '</span><span>–°–¥–µ–ª–∞–ª–∏ –∑–∞–ø—Ä–æ—Å—ã –∫ –®–∞–æ–ª–µ–Ω—å: ' + (d.users_with_shaolen_requests || 0) + '</span>';
      var t = q('#users-table tbody');
      t.innerHTML = '';
      users.forEach(function(u) {
        var name = [u.first_name, u.last_name].filter(Boolean).join(' ') || u.display_name || '‚Äî';
        var un = u.username ? '@' + u.username : '‚Äî';
        t.innerHTML += '<tr><td>' + u.user_id + '</td><td>' + escapeHtml(name) + '</td><td>' + escapeHtml(un) + '</td><td>' + (u.missions_count||0) + '</td><td>' + (u.goals_count||0) + '</td><td>' + (u.habits_count||0) + '</td><td>' + (u.shaolen_requests||0) + '</td><td><button type="button" class="btn-sm btn-user-data" data-user-id="' + u.user_id + '" data-user-name="' + escapeHtml(name) + '">–°–º–æ—Ç—Ä–µ—Ç—å</button></td></tr>';
      });
      t.parentElement.querySelectorAll('.btn-user-data').forEach(function(btn) {
        btn.onclick = function() {
          var uid = btn.dataset.userId;
          var uname = btn.dataset.userName || ('User ' + uid);
          q('#user-data-title').textContent = '–ú–∏—Å—Å–∏–∏, —Ü–µ–ª–∏, –ø—Ä–∏–≤—ã—á–∫–∏ ‚Äî ' + uname;
          q('#user-data-body').innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p>';
          q('#user-data-modal').style.display = 'flex';
          api('/api/admin/users/' + uid + '/data').then(function(data) {
            var html = '';
            var p = data.profile || {};
            html += '<div class="user-data-profile">';
            html += '<h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>';
            html += '<p><strong>–†–æ—Å—Ç:</strong> ' + (p.height != null ? escapeHtml(p.height) + ' —Å–º' : '‚Äî') + ' &nbsp; <strong>–í–µ—Å:</strong> ' + (p.weight != null ? escapeHtml(p.weight) + ' –∫–≥' : '‚Äî') + ' &nbsp; <strong>–í–æ–∑—Ä–∞—Å—Ç:</strong> ' + (p.age != null ? escapeHtml(p.age) + ' –ª–µ—Ç' : '‚Äî') + '</p>';
            html += '<p><strong>–ò–ú–¢:</strong> ' + (p.bmi != null ? escapeHtml(p.bmi) : '‚Äî') + (p.bmi_category ? ' &nbsp; <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ' + escapeHtml(p.bmi_category) : '') + '</p>';
            html += '</div>';
            html += '<h3>–ú–∏—Å—Å–∏–∏ (' + (data.missions && data.missions.length) + ')</h3><ul>';
            (data.missions || []).forEach(function(m) { html += '<li>' + escapeHtml(m.title || '‚Äî') + (m.is_completed ? ' <em>–∑–∞–≤–µ—Ä—à–µ–Ω–∞</em>' : '') + '</li>'; });
            html += '</ul>';
            html += '<h3>–¶–µ–ª–∏ (' + (data.goals && data.goals.length) + ')</h3><ul>';
            (data.goals || []).forEach(function(g) { html += '<li>' + escapeHtml(g.title || '‚Äî') + (g.is_completed ? ' <em>–∑–∞–≤–µ—Ä—à–µ–Ω–∞</em>' : '') + '</li>'; });
            html += '</ul>';
            html += '<h3>–ü—Ä–∏–≤—ã—á–∫–∏ (' + (data.habits && data.habits.length) + ')</h3><ul>';
            (data.habits || []).forEach(function(h) { html += '<li>' + escapeHtml(h.title || '‚Äî') + '</li>'; });
            html += '</ul>';
            q('#user-data-body').innerHTML = html || '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
          }).catch(function(e) { q('#user-data-body').innerHTML = '<p class="err">–û—à–∏–±–∫–∞: ' + escapeHtml(e.message || e) + '</p>'; });
        };
      });
    }).catch(function(e) { q('#users-summary').textContent = '–û—à–∏–±–∫–∞: ' + (e.message || e); });
  }

  q('#user-data-close').onclick = function() { q('#user-data-modal').style.display = 'none'; };
  q('#user-data-modal').onclick = function(e) { if (e.target.id === 'user-data-modal') q('#user-data-modal').style.display = 'none'; };

  function loadRequests() {
    if (!token) return;
    api('/api/admin/shaolen-requests?limit=200').then(function(d) {
      var list = d.requests || [];
      var t = q('#requests-table tbody');
      t.innerHTML = '';
      list.forEach(function(r) {
        var name = [r.first_name, r.last_name].filter(Boolean).join(' ') || r.display_name || '‚Äî';
        if (r.username) name += ' @' + r.username;
        var msgShort = (r.user_message || '').slice(0, 80);
        if ((r.user_message || '').length > 80) msgShort += '‚Ä¶';
        var dateStr = (r.created_at || '').slice(0, 16).replace('T', ' ');
        var row = '<tr class="req-row" data-id="' + r.id + '"><td>' + escapeHtml(dateStr) + '</td><td>' + escapeHtml(name) + '</td><td>' + escapeHtml(msgShort) + '</td><td>' + (r.has_image ? 'üì∑' : '‚Äî') + '</td></tr>';
        row += '<tr class="req-detail" id="req-detail-' + r.id + '" style="display:none"><td colspan="4"><div class="req-full req-req"><strong>–ó–∞–ø—Ä–æ—Å:</strong> ' + escapeHtml(r.user_message || '') + '</div><div class="req-full req-ans"><strong>–û—Ç–≤–µ—Ç:</strong> ' + escapeHtml(r.assistant_reply || '') + '</div><button class="copy-btn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä</button></td></tr>';
        t.innerHTML += row;
      });
      t.parentElement.querySelectorAll('.req-row').forEach(function(rowEl) {
        rowEl.onclick = function() {
          var id = rowEl.dataset.id;
          var detail = document.getElementById('req-detail-' + id);
          if (!detail) return;
          detail.style.display = detail.style.display === 'none' ? 'table-row' : 'none';
          rowEl.classList.toggle('expanded', detail.style.display !== 'none');
        };
      });
      t.parentElement.querySelectorAll('.copy-btn').forEach(function(btn) {
        btn.onclick = function(e) {
          e.stopPropagation();
          var tr = btn.closest('tr');
          if (!tr) return;
          var reqDiv = tr.querySelector('.req-req'), ansDiv = tr.querySelector('.req-ans');
          var reqT = reqDiv ? reqDiv.textContent.replace(/^\s*–ó–∞–ø—Ä–æ—Å:\s*/i, '').trim() : '';
          var ansT = ansDiv ? ansDiv.textContent.replace(/^\s*–û—Ç–≤–µ—Ç:\s*/i, '').trim() : '';
          var full = reqT + '\n\n--- –û—Ç–≤–µ—Ç ---\n' + ansT;
          navigator.clipboard.writeText(full).then(function(){ btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'; setTimeout(function(){ btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä'; }, 1500); });
        };
      });
    }).catch(function(e) { q('#requests-table tbody').innerHTML = '<tr><td colspan="4">–û—à–∏–±–∫–∞: ' + escapeHtml(e.message || e) + '</td></tr>'; });
  }

  if (token) { loadStatus(); loadLogs(); if (showExtendedTabs) { loadUsers(); loadRequests(); } }
  setInterval(loadStatus, 10000);
})();
  </script>
</body>
</html>
